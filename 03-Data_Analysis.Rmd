---
title: "Step III: Data Analysis"
subtitle: 'PACs and Small-dollar Donations'
author:
  - name: Nicholas R. Jenkins 
    affiliation: University of California, Riverside
    affiliation_url: https://www.ucr.edu
abstract: |
  This document shows all the code used to analyze the data for this project. 
  All analyses were done with R version `r R.version$major`.`r R.version$minor` 
  "`r R.version$nickname`" and Stan version `r stan_version()` in RStudio. 
  
  Each step has been carefully documented and will replicate the results in the 
  manuscript. The code for this document can be downloaded using the button 
  in the top right corner. For any questions about this code, please contact 
  Nick Jenkins at 
  [nicholas.jenkins@email.ucr.edu](mailto:nicholas.jenkins@email.ucr.edu).
date: "`r Sys.Date()`"
output: 
  html_notebook: 
    highlight: pygments
    theme: paper
    toc: yes
    code_folding: 
    toc_float: true
bibliography: /Users/nick/Documents/Research/References/BibTeX/biblatex.bib
editor_options: 
  chunk_output_type: inline
---

# Environment Preperation

This section clears the current working environment and loads the packages used to visualize the data. I also create the function `comma()` to format any in-line output values to have thousands separators and only two digits. 

```{r setup, warning = FALSE, message = FALSE, echo = TRUE, results = "hide"}
# Clear Environment -----------------------------------------------------------
rm(list = ls())

# Load Packages ---------------------------------------------------------------
packages <- c("tidyverse", "foreign", "stargazer", "lme4", "multcomp", 
              "lmerTest", "ggmcmc", "ggridges", "rstan", "rstanarm", "brms",
              "rethinking", "patchwork", "tidybayes", "sjstats", "sjPlot",
              "bayesplot", "sjmisc", "ggpubr", "broom", "scales", "ggthemes",
              "ggrepel", "BayesPostEst", "cmdstanr", "bayestestR")
lapply(packages, require, character.only = TRUE)

# Functions -------------------------------------------------------------------
# Inline Formatting
comma <- function(x) format(x, digits = 2, big.mark = ",")

# Inverse Hyperbolic Sin Transformation Function
ihs <- function(x) {
    y <- log(x + sqrt(x^2 + 1))
    return(y)
}

# Set Global Chunk Options ----------------------------------------------------
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "##",
  R.options = list(width = 70)
)
```


# Import Data

This section imports the data cleaned in the "Step I: Data Cleaning" document to begin analyzing the data. 

```{r Data Import}
load("Data/Clean Data/estimation_data.Rda")
#load("E:/Project/Data/Clean Data/estimation_data.RDa")

<<<<<<< HEAD
estimation.data <- 
=======
#psych::describeBy(estimation.data, group = estimation.data$no_corp_pacs)
```


# Vote Models

## Model of Vote Share

### Simulating Priors

```{r}
# likelihood simulation
ggplot() +
  geom_density(data = as_tibble(rgamma(1e4, shape = 20, rate = 100)), 
               aes(x = value)) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) 

# prior simulation
## Intercept
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(4), exp(3.5))),
               aes(x = value, fill = "Normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Intercept") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  xlim(-200, 200)

## Slope Parameters
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(0), exp(4))),
               aes(x = value, fill = "normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  xlim(-200, 200)

## Scale Parameter
ggplot() +
  geom_density(data = as_tibble(rexp(1e4, 1)), 
               aes(x = value, fill = "rate=1")) +
  geom_density(data = as_tibble(rexp(1e4, 2)), 
               aes(x = value, fill = "rate=2"), 
               alpha = 0.5) +
  theme_classic() +
  labs(x = "Mean and SD of Scale Parameter")

## Probability Parameter
ggplot() +
  geom_density(data = as_tibble(runif(1e4, 0, 1)), 
               aes(x = value, fill = "uniform")) +
  geom_density(data = as_tibble(rbeta(1e4, 2, 2)), 
               aes(x = value, fill = "beta 2"), 
               alpha = 0.5) +
    geom_density(data = as_tibble(rbeta(1e4, 1.5, 1.5)), 
               aes(x = value, fill = "beta 1.5"), 
               alpha = 0.7) +
  theme_classic() +
  labs(x = "Mean and SD of Probability Parameter")
```

### Model

```{stan output.var = "vote.model"}
data {
  int n;
  real vote_pct[n];
  real no_corp_pacs[n];
  real new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_tot_voting_age[n];
  real log_median_hh_income[n];
}

parameters {
  real a;
  real b_np;
  real b_new;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_clint;
  real b_house;
  real b_vpop;
  real b_mhh;
  real<lower = 0> scale;
  real prob;
}

model {
  vector[n] mu;
  
  // linear model
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_vpop * log_tot_voting_age[i] +
      b_mhh * log_median_hh_income[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(4, 3);
  b_np ~ normal(0, 3.5);
  b_new ~ normal(0, 3.5);
  b_white ~ normal(0, 3.5);
  b_black ~ normal(0, 3.5);
  b_latino ~ normal(0, 3.5);
  b_asian ~ normal(0, 3.5);
  b_bach ~ normal(0, 3.5);
  b_clint ~ normal(0, 3.5);
  b_house ~ normal(0, 3.5);
  b_vpop ~ normal(0, 3.5);
  b_mhh ~ normal(0, 3.5);
  scale ~ exponential(1);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (vote_pct[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(vote_pct[i]| mu[i]/scale, 1/scale));
    }//i 
}

generated quantities {
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_vpop * log_tot_voting_age[i] +
      b_mhh * log_median_hh_income[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
}
```

### Estimation

```{r Estimating Vote Share}
# compose data
stan.data <- 
>>>>>>> parent of 6f7fbd8 (calculating in vs out of state contributions)
  estimation.data %>%
  mutate(pct_white_c = std(pct_white, robust = "2sd"),
         pct_black_c = std(pct_black, robust = "2sd"),
         pct_latino_c = std(pct_latino, robust = "2sd"),
         pct_asian_c = std(pct_asian, robust = "2sd"),
         pct_bachelors_c = std(pct_bachelors, robust = "2sd"),
         pct_clinton_16_c = std(pct_clinton_16, robust = "2sd"),
         pct_dem_house_16_c = std(pct_dem_house_16, robust = "2sd"),
         log_tot_voting_age_c = std(log_tot_voting_age, robust = "2sd"),
         log_median_hh_income_c = std(log_median_hh_income, robust = "2sd"))
```


# PAC Models

## Model Fitting

```{r}
biz.pac.fit <- brm(bf(business_pacs ~ no_corp_pacs + new_member + pct_white_c +
                        pct_black_c + pct_latino_c + pct_asian_c + 
                        pct_bachelors_c + pct_clinton_16_c + 
                        pct_dem_house_16_c + log_tot_voting_age_c +
                        log_median_hh_income_c,
                      hu ~ no_corp_pacs + new_member),
                   family = hurdle_gamma(link = "log", link_hu = "logit"),
                   prior = c(prior(normal(13, 12), class = Intercept),
                             prior(normal(-1, 0.5), class = b, 
                                   coef = "no_corp_pacsYES"),
                             prior(normal(0, 0.5), class = b),
                             prior(normal(0, 1), dpar = "hu", class = Intercept),
                             prior(normal(0, 0.5), dpar = "hu", class = b)),
                   sample_prior = "yes",
                   cores = 4,
                   iter = 4000,
                   backend = "cmdstan",
                   data = estimation.data)

describe_posterior(biz.pac.fit, ci = 0.9, ci_method = "hdi",
                   test = c("p_direction"))

num.pac.fit <- brm(num_pac_contribs ~ no_corp_pacs + new_member + pct_white_c +
                     pct_black_c + pct_latino_c + pct_asian_c + 
                     pct_bachelors_c + pct_clinton_16_c + 
                     pct_dem_house_16_c + log_tot_voting_age_c +
                     log_median_hh_income_c,
                   family = negbinomial(link = "log"),
                   prior = c(prior(normal(7, 6), class = Intercept),
                             prior(normal(-1, 0.5), class = b, 
                                   coef = "no_corp_pacsYES"),
                             prior(normal(0, 0.5), class = b)),
                   sample_prior = "yes",
                   cores = 4,
                   iter = 4000,
                   backend = "cmdstan",
                   data = estimation.data)

describe_posterior(num.pac.fit, ci = 0.9, ci_method = "hdi",
                   test = c("p_direction"))
```

## Model Diagnostics

### Prior Influence

```{r}
# business pac contributions
biz.pac.priors <- prior_samples(biz.pac.fit)
biz.pac.post <- posterior_samples(biz.pac.fit)

ggplot() +
  geom_density(data = biz.pac.priors, aes(x = b_no_corp_pacsYES)) +
  geom_density(data = biz.pac.post, aes(x = b_no_corp_pacsYES))

# number of business pac contributions
num.pac.priors <- prior_samples(num.pac.fit)
num.pac.post <- posterior_samples(num.pac.fit)

ggplot() +
  geom_density(data = num.pac.priors, aes(x = b_no_corp_pacsYES)) +
  geom_density(data = num.pac.post, aes(x = b_no_corp_pacsYES))
```

### Posterior Predictive Checks

```{r}
# business pac contributions --------------------------------------------------
y.biz.pac <- estimation.data$business_pacs

# extract the fitted values
y.rep <- posterior_predict(biz.pac.fit, draws = 500)
dim(y.rep)

ppc_dens_overlay(y = y.biz.pac[1:235], yrep = y.rep[1:100, ])

# number business pac contributors --------------------------------------------
y.num.pac <- estimation.data$num_pac_contribs

# extract the fitted values
y.rep <- posterior_predict(num.pac.fit, draws = 500)
dim(y.rep)

ppc_dens_overlay(y = y.num.pac[1:235], yrep = y.rep[1:100, ])
```


## Model Results

### Results Tables

```{r}
library(xtable)

# Business PAC Fit
xtable(describe_posterior(biz.pac.fit, ci = 0.9, ci_method = "hdi",
                   test = c("p_direction")))
```

### Coefficient Plots

```{r}
# Gamma Likelihood ------------------------------------------------------------
# extract posterior predictions
biz.pac.coef <- 
  biz.pac.fit %>%
  spread_draws(b_no_corp_pacsYES) %>%
  mutate(model = "Business PAC $")

## main effects
library(latex2exp)
biz.pac.coef %>%
  mutate(b_np = exp(b_no_corp_pacsYES) - 1) %>%
  ggplot() +
  stat_halfeyeh(aes(y = fct_reorder(model, b_np), x = b_np), 
                .width = c(0.9), 
                point_interval = median_hdi,
                fill = "#A4A4A4",
                color = "black",
                alpha = 0.9) +
  geom_vline(aes(xintercept = 0), linetype = "dashed", color = "grey55") +
  scale_x_continuous(labels = percent_format(),
                     breaks = pretty_breaks(n = 6)) +
  labs(x = TeX("% Change in Contributions ($\\e^{\\beta} - 1$)"), 
       y = "Outcome Variable") +
  theme_pubr() +
  theme(axis.text.y = element_text(angle = 90, vjust = 0, hjust = 0.5))
ggsave("Figures/Results/pac_gamma_coef.pdf", height = 4, width = 7) 

# Binomial Likelihood ---------------------------------------------------------
biz.pac.coef <- 
  biz.pac.fit %>%
  spread_draws(b_hu_no_corp_pacsYES) %>%
  mutate(model = "Business PAC $")

## main effects
library(latex2exp)
biz.pac.coef %>%
  mutate(b_np = plogis(b_hu_no_corp_pacsYES)) %>%
  ggplot() +
  stat_halfeyeh(aes(y = fct_reorder(model, b_np), x = b_np), 
                .width = c(0.9), 
                point_interval = median_hdi,
                fill = "#A4A4A4",
                color = "black",
                alpha = 0.9) +
  geom_vline(aes(xintercept = 0), linetype = "dashed", color = "grey55") +
  scale_x_continuous(labels = percent_format(),
                     breaks = pretty_breaks(n = 6)) +
  labs(x = TeX("Probability of Not Receiving Contributions ($logit^{-1}(\\beta)$)"), 
       y = "Outcome Variable") +
  theme_pubr()
ggsave("Figures/Results/pac_binom_coef.pdf", height = 4, width = 7) 
```


# Individual Models

## Model Fitting

```{r}
small.indv.fit <- brm(small_indiv ~ no_corp_pacs + new_member + pct_white_c +
                           pct_black_c + pct_latino_c + pct_asian_c + 
                           pct_bachelors_c + pct_clinton_16_c + 
                           pct_dem_house_16_c + log_tot_voting_age_c +
                           log_median_hh_income_c,
                      family = Gamma(link = "log"),
                      prior = c(prior(normal(13, 13), class = Intercept),
                                prior(normal(0.2, 0.5), class = b, 
                                      coef = "no_corp_pacsYES"),
                                prior(normal(0, 0.5), class = b)),
                      sample_prior = "yes",
                      cores = 4,
                      iter = 4000,
                      backend = "cmdstan",
                      data = estimation.data)

describe_posterior(small.indv.fit, ci = 0.9, ci_method = "hdi",
                   test = c("p_direction"))

biz.indv.fit <- brm(biz_contribs ~ no_corp_pacs + new_member + pct_white_c +
                      pct_black_c + pct_latino_c + pct_asian_c + 
                      pct_bachelors_c + pct_clinton_16_c + pct_dem_house_16_c + 
                      log_tot_voting_age_c + log_median_hh_income_c,
                    family = Gamma(link = "log"),
                    prior = c(prior(normal(13, 13), class = Intercept),
                              prior(normal(0, 0.5), class = b)),
                    sample_prior = "yes",
                    cores = 4,
                    iter = 4000,
                    backend = "cmdstan",
                    data = estimation.data)

describe_posterior(biz.indv.fit, ci = 0.9, ci_method = "hdi",
                   test = c("p_direction"))

out.dist.biz.fit <- brm(bf(out_of_dist_biz_contrib ~ no_corp_pacs + new_member + 
                             pct_white_c + pct_black_c + pct_latino_c + 
                             pct_asian_c + pct_bachelors_c + pct_clinton_16_c + 
                             pct_dem_house_16_c + log_tot_voting_age_c +
                             log_median_hh_income_c,
                           hu ~ no_corp_pacs + new_member),
                        family = hurdle_gamma(link = "log", link_hu = "logit"),
                        prior = c(prior(normal(13, 13), class = Intercept),
                                  prior(normal(0, 0.5), class = b),
                                  prior(normal(0, 1), dpar = "hu", class = Intercept),
                                  prior(normal(0, 0.5), dpar = "hu", class = b)),
                        sample_prior = "yes",
                        cores = 4,
                        iter = 4000,
                        backend = "cmdstan",
                        data = estimation.data)

describe_posterior(out.dist.biz.fit, ci = 0.9, ci_method = "hdi",
                   test = c("p_direction"))
```

## Model Diagnostics

### Prior Influence

```{r}
# small individual contributions ----------------------------------------------
small.indiv.priors <- prior_samples(small.indv.fit)
small.indiv.post <- posterior_samples(small.indv.fit)

ggplot() +
  geom_density(data = small.indiv.priors, aes(x = b_no_corp_pacsYES)) +
  geom_density(data = small.indiv.post, aes(x = b_no_corp_pacsYES))

# business individual contributions -------------------------------------------
biz.indv.priors <- prior_samples(biz.indv.fit)
biz.indv.post <- posterior_samples(biz.indv.fit)

ggplot() +
  geom_density(data = biz.indv.priors, aes(x = b)) +
  geom_density(data = biz.indv.post, aes(x = b_no_corp_pacsYES))

# business individual contributions from out-of-district ----------------------
out.biz.indv.priors <- prior_samples(out.dist.biz.fit)
out.biz.indv.post <- posterior_samples(out.dist.biz.fit)

ggplot() +
  geom_density(data = out.biz.indv.priors, aes(x = b)) +
  geom_density(data = out.biz.indv.post, aes(x = b_no_corp_pacsYES))
```

### Posterior Predictive Checks

```{r}
# # small individual contributions --------------------------------------------
y.small.indv <- estimation.data$small_indiv

# extract the fitted values
y.rep <- posterior_predict(small.indv.fit, draws = 500)
dim(y.rep)

ppc_dens_overlay(y = y.small.indv[1:235], yrep = y.rep[1:100, ]) + 
  xlim(0, 400000)

# business individual contributions -------------------------------------------
y.biz.indv <- estimation.data$indiv_biz

# extract the fitted values
y.rep <- posterior_predict(biz.indv.fit, draws = 500)
dim(y.rep)

ppc_dens_overlay(y = y.biz.indv[1:235], yrep = y.rep[1:100, ]) +
  xlim(0, 5000000)
```


## Model Results

### Results Tables

```{r}

```

### Coefficient Plots

```{r}
# Gamma Likelihood ------------------------------------------------------------
# extract posterior predictions
small.indv.coef <- 
  small.indv.fit %>%
  spread_draws(b_no_corp_pacsYES) %>%
  mutate(model = "Small Indiv. $")

biz.indv.coef <- 
  biz.indv.fit %>%
  spread_draws(b_no_corp_pacsYES) %>%
  mutate(model = "Business Indiv. $")

out.biz.indv.coef <- 
  out.dist.biz.fit %>%
  spread_draws(b_no_corp_pacsYES) %>%
  mutate(model = "Out-of-District Business Indiv. $")

indv.models <- 
  bind_rows(small.indv.coef, biz.indv.coef, out.biz.indv.coef) %>%
  mutate(b_np = exp(b_no_corp_pacsYES) - 1)

## main effects
library(latex2exp)
indv.models %>%
  #filter(model == "Out-of-District Business Indiv. $") %>%
  ggplot() +
  stat_halfeyeh(aes(y = fct_reorder(model, b_np), x = b_np), 
                .width = c(0.9), 
                point_interval = median_hdi,
                fill = "#A4A4A4",
                color = "black",
                alpha = 0.9) +
  geom_vline(aes(xintercept = 0), linetype = "dashed", color = "grey55") +
  scale_x_continuous(labels = percent_format(),
                     breaks = pretty_breaks(n = 6)) +
  labs(x = TeX("% Change in Contributions ($\\e^{\\beta} - 1$)"), 
       y = "Outcome Variable") +
  theme_pubr()
ggsave("Figures/Results/indv_gamma_coef.pdf", height = 4, width = 7) 

# Binomial Likelihood ---------------------------------------------------------
out.biz.indv.coef <- 
  out.dist.biz.fit %>%
  spread_draws(b_hu_no_corp_pacsYES) %>%
  mutate(model = "Out-of-District Business Indiv. $")

## main effects
library(latex2exp)
out.biz.indv.coef %>%
  rename(b_np = b_hu_no_corp_pacsYES) %>%
  ggplot() +
  stat_halfeyeh(aes(y = fct_reorder(model, b_np), x = b_np), 
                .width = c(0.9), 
                point_interval = median_hdi,
                fill = "#A4A4A4",
                color = "black",
                alpha = 0.9) +
  geom_vline(aes(xintercept = 0), linetype = "dashed", color = "grey55") +
  scale_x_continuous(labels = percent_format(),
                     breaks = pretty_breaks(n = 4)) +
  labs(x = TeX("Probability of Not Receiving Contributions ($logit^{-1}(\\beta)$)"), 
       y = "Outcome Variable") +
  theme_pubr()
ggsave("Figures/Results/indv_binom_coef.pdf", height = 4, width = 7) 
```


# Proportion Models

```{r}
<<<<<<< HEAD
estimation.data <- 
=======
# likelihood simulation
ggplot() +
  geom_density(data = as_tibble(rgamma(1e4, shape = 20, rate = 100)), 
               aes(x = value)) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) 

# prior simulation
## Intercept
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(10.5), exp(13))),
               aes(x = value, fill = "Normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Intercept") +
  scale_x_continuous(labels = dollar_format()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

## Slope Parameters
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(0), exp(12))),
               aes(x = value, fill = "normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(labels = dollar_format()) 

## Scale Parameter
ggplot() +
  geom_density(data = as_tibble(rexp(1e4, 1)), 
               aes(x = value, fill = "rate=1")) +
  geom_density(data = as_tibble(rexp(1e4, 2)), 
               aes(x = value, fill = "rate=2"), 
               alpha = 0.5) +
  theme_classic() +
  labs(x = "Mean and SD of Scale Parameter")

## Probability Parameter
ggplot() +
  geom_density(data = as_tibble(runif(1e4, 0, 1)), 
               aes(x = value, fill = "uniform")) +
  geom_density(data = as_tibble(rbeta(1e4, 2, 2)), 
               aes(x = value, fill = "beta 2"), 
               alpha = 0.5) +
    geom_density(data = as_tibble(rbeta(1e4, 1.5, 1.5)), 
               aes(x = value, fill = "beta 1.5"), 
               alpha = 0.7) +
  theme_classic() +
  labs(x = "Mean and SD of Probability Parameter")
```

### Model 

```{stan output.var = "indideopac.model"}
data {
  int<lower = 1> n;
  real ind_pac_ideological[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real<lower = 0, upper = 1> prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(10.5, 13);
  b_np ~ normal(0, 12);
  b_new ~ normal(0, 12);
  b_white ~ normal(0, 12);
  b_black ~ normal(0, 12);
  b_latino ~ normal(0, 12);
  b_asian ~ normal(0, 12);
  b_bach ~ normal(0, 12);
  b_clint ~ normal(0, 12);
  b_house ~ normal(0, 12);
  b_vpop ~ normal(0, 12);
  b_mhh ~ normal(0, 12);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (ind_pac_ideological[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(ind_pac_ideological[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

```{stan output.var = "int_indideopac.model"}
data {
  int<lower = 1> n;
  real ind_pac_ideological[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_int;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real<lower = 0, upper = 1> prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] +
      b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(10.5, 13);
  b_np ~ normal(0, 12);
  b_new ~ normal(0, 12);
  b_int ~ normal(0, 12);
  b_white ~ normal(0, 12);
  b_black ~ normal(0, 12);
  b_latino ~ normal(0, 12);
  b_asian ~ normal(0, 12);
  b_bach ~ normal(0, 12);
  b_clint ~ normal(0, 12);
  b_house ~ normal(0, 12);
  b_vpop ~ normal(0, 12);
  b_mhh ~ normal(0, 12);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (ind_pac_ideological[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(ind_pac_ideological[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] +
    b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

### Estimation

```{r}
# compose data
stan.data <- 
  estimation.data %>%
  dplyr::select(ind_pac_ideological, no_corp_pacs, new_member, pct_white, pct_black, 
                pct_latino, pct_asian, pct_bachelors, pct_clinton_16,
                pct_dem_house_16, log_tot_voting_age, log_median_hh_income) %>%
  mutate(no_corp_pacs = ifelse(no_corp_pacs == "YES", 1, 0),
         new_member = ifelse(new_member == "YES", 1, 0)) %>%
  drop_na() %>%
  mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center) %>%
  compose_data()

# model estimation ------------------------------------------------------------
## Frequentist
# indideol.pacs.01 <- glm(ind_pac_ideological ~ no_corp_pacs + new_member + pct_white + pct_black + pct_latino + pct_asian + pct_bachelors + pct_clinton_16 + pct_dem_house_16 + log_median_hh_income + log_tot_voting_age,
#                      family = Gamma(link = "log"),
#                      data = as.data.frame(stan.data) %>% filter(ind_pac_ideological != 0) %>% mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center))

## Bayesian
indideopac.fit <- sampling(indideopac.model,
                        chains = 4,
                        cores = 4,
                        iter = 8000,
                        warmup = 4000,
                        data = stan.data)

traceplot(indideopac.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

#tidy(indideol.pacs.01, conf.int = TRUE, conf.level = 0.89, digits = 3)
precis(indideopac.fit, prob = 0.89, digits = 3)

post <- spread_draws(indideopac.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = ind_pac_ideological)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7)

int_indideopac.fit <- sampling(int_indideopac.model,
                               chains = 4,
                               cores = 4,
                               iter = 8000,
                               warmup = 4000,
                               data = stan.data)

traceplot(int_indideopac.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_int", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

#tidy(indideol.pacs.01, conf.int = TRUE, conf.level = 0.89, digits = 3)
precis(int_indideopac.fit, prob = 0.89, digits = 3)

post <- spread_draws(int_indideopac.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = ind_pac_ideological)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7)
```


## Model of Direct Ideological PAC Contributions

### Simulating Priors

```{r}
# likelihood simulation
ggplot() +
  geom_density(data = as_tibble(rgamma(1e4, shape = 20, rate = 100)), 
               aes(x = value)) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) 

# prior simulation
## Intercept
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(10.5), exp(13))),
               aes(x = value, fill = "Normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Intercept") +
  scale_x_continuous(labels = dollar_format()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

## Slope Parameters
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(0), exp(12))),
               aes(x = value, fill = "normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(labels = dollar_format()) 

## Scale Parameter
ggplot() +
  geom_density(data = as_tibble(rexp(1e4, 1)), 
               aes(x = value, fill = "rate=1")) +
  geom_density(data = as_tibble(rexp(1e4, 2)), 
               aes(x = value, fill = "rate=2"), 
               alpha = 0.5) +
  theme_classic() +
  labs(x = "Mean and SD of Scale Parameter")

## Probability Parameter
ggplot() +
  geom_density(data = as_tibble(runif(1e4, 0, 1)), 
               aes(x = value, fill = "uniform")) +
  geom_density(data = as_tibble(rbeta(1e4, 2, 2)), 
               aes(x = value, fill = "beta 2"), 
               alpha = 0.5) +
    geom_density(data = as_tibble(rbeta(1e4, 1.5, 1.5)), 
               aes(x = value, fill = "beta 1.5"), 
               alpha = 0.7) +
  theme_classic() +
  labs(x = "Mean and SD of Probability Parameter")
```

### Model 

```{stan output.var = "dirideopac.model"}
data {
  int<lower = 1> n;
  real dir_pac_ideological[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real<lower = 0, upper = 1> prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(10.5, 13);
  b_np ~ normal(0, 12);
  b_new ~ normal(0, 12);
  b_white ~ normal(0, 12);
  b_black ~ normal(0, 12);
  b_latino ~ normal(0, 12);
  b_asian ~ normal(0, 12);
  b_bach ~ normal(0, 12);
  b_clint ~ normal(0, 12);
  b_house ~ normal(0, 12);
  b_vpop ~ normal(0, 12);
  b_mhh ~ normal(0, 12);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (dir_pac_ideological[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(dir_pac_ideological[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

```{stan output.var = "int_dirideopac.model"}
data {
  int<lower = 1> n;
  real dir_pac_ideological[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_int;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real<lower = 0, upper = 1> prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] +
      b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(10.5, 13);
  b_np ~ normal(0, 12);
  b_new ~ normal(0, 12);
  b_int ~ normal(0, 12);
  b_white ~ normal(0, 12);
  b_black ~ normal(0, 12);
  b_latino ~ normal(0, 12);
  b_asian ~ normal(0, 12);
  b_bach ~ normal(0, 12);
  b_clint ~ normal(0, 12);
  b_house ~ normal(0, 12);
  b_vpop ~ normal(0, 12);
  b_mhh ~ normal(0, 12);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (dir_pac_ideological[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(dir_pac_ideological[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] +
      b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

### Estimation

```{r}
# compose data
stan.data <- 
  estimation.data %>%
  dplyr::select(dir_pac_ideological, no_corp_pacs, new_member, pct_white, pct_black, 
                pct_latino, pct_asian, pct_bachelors, pct_clinton_16,
                pct_dem_house_16, log_tot_voting_age, log_median_hh_income) %>%
  mutate(no_corp_pacs = ifelse(no_corp_pacs == "YES", 1, 0),
         new_member = ifelse(new_member == "YES", 1, 0)) %>%
  drop_na() %>%
  mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center) %>%
  compose_data()

# model estimation ------------------------------------------------------------
## Frequentist
dirideol.pacs.01 <- glm(dir_pac_ideological ~ no_corp_pacs + new_member + pct_white + pct_black + pct_latino + pct_asian + pct_bachelors + pct_clinton_16 + pct_dem_house_16 + log_median_hh_income + log_tot_voting_age,
                     family = Gamma(link = "log"),
                     data = as.data.frame(stan.data) %>% filter(dir_pac_ideological != 0) %>% mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center))

## Bayesian
dirideopac.fit <- sampling(dirideopac.model,
                        chains = 4,
                        cores = 4,
                        iter = 8000,
                        warmup = 4000,
                        data = stan.data)

traceplot(dirideopac.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

tidy(dirideol.pacs.01, conf.int = TRUE, conf.level = 0.89, digits = 3)
precis(dirideopac.fit, prob = 0.89, digits = 3)

post <- spread_draws(dirideopac.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = dir_pac_ideological)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7)

ind_dirideopac.fit <- sampling(int_dirideopac.model,
                               chains = 4,
                               cores = 4,
                               iter = 8000,
                               warmup = 4000,
                               data = stan.data)

traceplot(ind_dirideopac.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_int", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

precis(ind_dirideopac.fit, prob = 0.89, digits = 3)

post <- spread_draws(ind_dirideopac.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = dir_pac_ideological)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7)
```


# Party Models

## Model of Leadership PAC Contributions

### Simulating Priors

```{r}
# likelihood simulation
ggplot() +
  geom_density(data = as_tibble(rgamma(1e4, shape = 20, rate = 100)), 
               aes(x = value)) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) 

# prior simulation
## Intercept
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(10.5), exp(13))),
               aes(x = value, fill = "Normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Intercept") +
  scale_x_continuous(labels = dollar_format()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

## Slope Parameters
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(0), exp(12))),
               aes(x = value, fill = "normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(labels = dollar_format()) 

## Scale Parameter
ggplot() +
  geom_density(data = as_tibble(rexp(1e4, 1)), 
               aes(x = value, fill = "rate=1")) +
  geom_density(data = as_tibble(rexp(1e4, 2)), 
               aes(x = value, fill = "rate=2"), 
               alpha = 0.5) +
  theme_classic() +
  labs(x = "Mean and SD of Scale Parameter")

## Probability Parameter
ggplot() +
  geom_density(data = as_tibble(runif(1e4, 0, 1)), 
               aes(x = value, fill = "uniform")) +
  geom_density(data = as_tibble(rbeta(1e4, 2, 2)), 
               aes(x = value, fill = "beta 2"), 
               alpha = 0.5) +
    geom_density(data = as_tibble(rbeta(1e4, 1.5, 1.5)), 
               aes(x = value, fill = "beta 1.5"), 
               alpha = 0.7) +
  theme_classic() +
  labs(x = "Mean and SD of Probability Parameter")
```

### Model 

```{stan output.var = "ldrpac.model"}
data {
  int<lower = 1> n;
  real leadership_pacs[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(10.5, 13);
  b_np ~ normal(0, 12);
  b_new ~ normal(0, 12);
  b_white ~ normal(0, 12);
  b_black ~ normal(0, 12);
  b_latino ~ normal(0, 12);
  b_asian ~ normal(0, 12);
  b_bach ~ normal(0, 12);
  b_clint ~ normal(0, 12);
  b_house ~ normal(0, 12);
  b_vpop ~ normal(0, 12);
  b_mhh ~ normal(0, 12);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (leadership_pacs[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(leadership_pacs[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

```{stan output.var = "int_ldrpac.model"}
data {
  int<lower = 1> n;
  real leadership_pacs[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_int;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(10.5, 13);
  b_np ~ normal(0, 12);
  b_new ~ normal(0, 12);
  b_int ~ normal(0, 12); 
  b_white ~ normal(0, 12);
  b_black ~ normal(0, 12);
  b_latino ~ normal(0, 12);
  b_asian ~ normal(0, 12);
  b_bach ~ normal(0, 12);
  b_clint ~ normal(0, 12);
  b_house ~ normal(0, 12);
  b_vpop ~ normal(0, 12);
  b_mhh ~ normal(0, 12);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (leadership_pacs[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(leadership_pacs[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

### Estimation

```{r}
# compose data
stan.data <- 
  estimation.data %>%
  dplyr::select(leadership_pacs, no_corp_pacs, new_member, pct_white, pct_black, 
                pct_latino, pct_asian, pct_bachelors, pct_clinton_16,
                pct_dem_house_16, log_tot_voting_age, log_median_hh_income) %>%
  mutate(no_corp_pacs = ifelse(no_corp_pacs == "YES", 1, 0),
         new_member = ifelse(new_member == "YES", 1, 0)) %>%
  drop_na() %>%
  mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center) %>%
  compose_data()

# model estimation ------------------------------------------------------------
## Frequentist
ldr.pacs.01 <- glm(leadership_pacs ~ no_corp_pacs + new_member + pct_white + pct_black + pct_latino + pct_asian + pct_bachelors + pct_clinton_16 + pct_dem_house_16 + log_median_hh_income + log_tot_voting_age,
                   family = Gamma(link = "log"),
                   data = as.data.frame(stan.data) %>% filter(leadership_pacs != 0) %>% mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center))

## Bayesian
ldrpac.fit <- sampling(ldrpac.model,
                       chains = 4,
                       cores = 4,
                       iter = 8000,
                       warmup = 4000,
                       data = stan.data)

traceplot(ldrpac.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

tidy(ldr.pacs.01, conf.int = TRUE, conf.level = 0.89, digits = 3)
precis(ldrpac.fit, prob = 0.89, digits = 3)

post <- spread_draws(ldrpac.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = leadership_pacs)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7)

int_ldrpac.fit <- sampling(int_ldrpac.model,
                           chains = 4,
                           cores = 4,
                           iter = 8000,
                           warmup = 4000,
                           data = stan.data)

traceplot(int_ldrpac.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_int", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

precis(int_ldrpac.fit, prob = 0.89, digits = 3)

post <- spread_draws(int_ldrpac.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = leadership_pacs)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7)
```


## Model of Committee PAC Contributions

### Simulating Priors

```{r}
# likelihood simulation
ggplot() +
  geom_density(data = as_tibble(rgamma(1e4, shape = 20, rate = 100)), 
               aes(x = value)) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) 

# prior simulation
## Intercept
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(10.5), exp(13))),
               aes(x = value, fill = "Normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Intercept") +
  scale_x_continuous(labels = dollar_format()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

## Slope Parameters
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(0), exp(12))),
               aes(x = value, fill = "normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(labels = dollar_format()) 

## Scale Parameter
ggplot() +
  geom_density(data = as_tibble(rexp(1e4, 1)), 
               aes(x = value, fill = "rate=1")) +
  geom_density(data = as_tibble(rexp(1e4, 2)), 
               aes(x = value, fill = "rate=2"), 
               alpha = 0.5) +
  theme_classic() +
  labs(x = "Mean and SD of Scale Parameter")

## Probability Parameter
ggplot() +
  geom_density(data = as_tibble(runif(1e4, 0, 1)), 
               aes(x = value, fill = "uniform")) +
  geom_density(data = as_tibble(rbeta(1e4, 2, 2)), 
               aes(x = value, fill = "beta 2"), 
               alpha = 0.5) +
    geom_density(data = as_tibble(rbeta(1e4, 1.5, 1.5)), 
               aes(x = value, fill = "beta 1.5"), 
               alpha = 0.7) +
  theme_classic() +
  labs(x = "Mean and SD of Probability Parameter")
```

### Model 

```{stan output.var = "cmtpac.model"}
data {
  int<lower = 1> n;
  real dir_pac_cand_committee[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(10.5, 13);
  b_np ~ normal(0, 12);
  b_new ~ normal(0, 12);
  b_white ~ normal(0, 12);
  b_black ~ normal(0, 12);
  b_latino ~ normal(0, 12);
  b_asian ~ normal(0, 12);
  b_bach ~ normal(0, 12);
  b_clint ~ normal(0, 12);
  b_house ~ normal(0, 12);
  b_vpop ~ normal(0, 12);
  b_mhh ~ normal(0, 12);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (dir_pac_cand_committee[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(dir_pac_cand_committee[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

```{stan output.var = "int_cmtpac.model"}
data {
  int<lower = 1> n;
  real dir_pac_cand_committee[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_int;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] +
      b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(10.5, 13);
  b_np ~ normal(0, 12);
  b_new ~ normal(0, 12);
  b_int ~ normal(0, 12);
  b_white ~ normal(0, 12);
  b_black ~ normal(0, 12);
  b_latino ~ normal(0, 12);
  b_asian ~ normal(0, 12);
  b_bach ~ normal(0, 12);
  b_clint ~ normal(0, 12);
  b_house ~ normal(0, 12);
  b_vpop ~ normal(0, 12);
  b_mhh ~ normal(0, 12);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (dir_pac_cand_committee[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(dir_pac_cand_committee[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] +
      b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

### Estimation

```{r}
# compose data
stan.data <- 
  estimation.data %>%
  dplyr::select(dir_pac_cand_committee, no_corp_pacs, new_member, pct_white, pct_black, 
                pct_latino, pct_asian, pct_bachelors, pct_clinton_16,
                pct_dem_house_16, log_tot_voting_age, log_median_hh_income) %>%
  mutate(no_corp_pacs = ifelse(no_corp_pacs == "YES", 1, 0),
         new_member = ifelse(new_member == "YES", 1, 0)) %>%
  drop_na() %>%
  mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center) %>%
  compose_data()

# model estimation ------------------------------------------------------------
## Frequentist
cmte.pacs.01 <- glm(dir_pac_cand_committee ~ no_corp_pacs + new_member + pct_white + pct_black + pct_latino + pct_asian + pct_bachelors + pct_clinton_16 + pct_dem_house_16 + log_median_hh_income + log_tot_voting_age,
                     family = Gamma(link = "log"),
                     data = as.data.frame(stan.data) %>% filter(dir_pac_cand_committee != 0) %>% mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center))

## Bayesian
cmtpac.fit <- sampling(cmtpac.model,
                       chains = 4,
                       cores = 4,
                       iter = 8000,
                       warmup = 4000,
                       data = stan.data)

traceplot(cmtpac.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

tidy(cmte.pacs.01, conf.int = TRUE, conf.level = 0.89, digits = 3)
precis(cmtpac.fit, prob = 0.89, digits = 3)

post <- spread_draws(cmtpac.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = dir_pac_cand_committee)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7)

int_cmtpac.fit <- sampling(int_cmtpac.model,
                           chains = 4,
                           cores = 4,
                           iter = 8000,
                           warmup = 4000,
                           data = stan.data)

traceplot(int_cmtpac.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_int", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

precis(int_cmtpac.fit, prob = 0.89, digits = 3)

post <- spread_draws(int_cmtpac.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = dir_pac_cand_committee)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7)
```

## Model of Party Contributions

### Simulating Priors

```{r}
# likelihood simulation
ggplot() +
  geom_density(data = as_tibble(rgamma(1e4, shape = 20, rate = 100)), 
               aes(x = value)) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) 

# prior simulation
## Intercept
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(12), exp(14))),
               aes(x = value, fill = "Normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Intercept") +
  scale_x_continuous(labels = dollar_format()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

## Slope Parameters
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(0), exp(13))),
               aes(x = value, fill = "normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(labels = dollar_format()) 

## Scale Parameter
ggplot() +
  geom_density(data = as_tibble(rexp(1e4, 1)), 
               aes(x = value, fill = "rate=1")) +
  geom_density(data = as_tibble(rexp(1e4, 2)), 
               aes(x = value, fill = "rate=2"), 
               alpha = 0.5) +
  theme_classic() +
  labs(x = "Mean and SD of Scale Parameter")

## Probability Parameter
ggplot() +
  geom_density(data = as_tibble(runif(1e4, 0, 1)), 
               aes(x = value, fill = "uniform")) +
  geom_density(data = as_tibble(rbeta(1e4, 2, 2)), 
               aes(x = value, fill = "beta 2"), 
               alpha = 0.5) +
    geom_density(data = as_tibble(rbeta(1e4, 1.5, 1.5)), 
               aes(x = value, fill = "beta 1.5"), 
               alpha = 0.7) +
  theme_classic() +
  labs(x = "Mean and SD of Probability Parameter")
```

### Model 

```{stan output.var = "prtypac.model"}
data {
  int<lower = 1> n;
  real dir_pac_party_committee[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(12, 14);
  b_np ~ normal(0, 13);
  b_new ~ normal(0, 13);
  b_white ~ normal(0, 13);
  b_black ~ normal(0, 13);
  b_latino ~ normal(0, 13);
  b_asian ~ normal(0, 13);
  b_bach ~ normal(0, 13);
  b_clint ~ normal(0, 13);
  b_house ~ normal(0, 13);
  b_vpop ~ normal(0, 13);
  b_mhh ~ normal(0, 13);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (dir_pac_party_committee[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(dir_pac_party_committee[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

```{stan output.var = "int_prtypac.model"}
data {
  int<lower = 1> n;
  real dir_pac_party_committee[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_int;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] +
      b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(12, 14);
  b_np ~ normal(0, 13);
  b_new ~ normal(0, 13);
  b_int ~ normal(0, 13);
  b_white ~ normal(0, 13);
  b_black ~ normal(0, 13);
  b_latino ~ normal(0, 13);
  b_asian ~ normal(0, 13);
  b_bach ~ normal(0, 13);
  b_clint ~ normal(0, 13);
  b_house ~ normal(0, 13);
  b_vpop ~ normal(0, 13);
  b_mhh ~ normal(0, 13);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (dir_pac_party_committee[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(dir_pac_party_committee[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] +
      b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

### Estimation

```{r}
# compose data
stan.data <- 
  estimation.data %>%
  dplyr::select(dir_pac_party_committee, no_corp_pacs, new_member, pct_white, pct_black, 
                pct_latino, pct_asian, pct_bachelors, pct_clinton_16,
                pct_dem_house_16, log_tot_voting_age, log_median_hh_income) %>%
  mutate(no_corp_pacs = ifelse(no_corp_pacs == "YES", 1, 0),
         new_member = ifelse(new_member == "YES", 1, 0)) %>%
  drop_na() %>%
  mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center) %>%
  compose_data()

# model estimation ------------------------------------------------------------
## Frequentist
party.contribs.01 <- glm(dir_pac_party_committee ~ no_corp_pacs + new_member + pct_white + pct_black + pct_latino + pct_asian + pct_bachelors + pct_clinton_16 + pct_dem_house_16 + log_median_hh_income + log_tot_voting_age,
                     family = Gamma(link = "log"),
                     data = as.data.frame(stan.data) %>% filter(dir_pac_party_committee != 0) %>% mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center))

## Bayesian
prtypac.fit <- sampling(prtypac.model,
                        chains = 4,
                        cores = 4,
                        iter = 8000,
                        warmup = 4000,
                        data = stan.data)

traceplot(prtypac.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

tidy(party.contribs.01, conf.int = TRUE, conf.level = 0.89, digits = 3)
precis(prtypac.fit, prob = 0.89, digits = 3)

post <- spread_draws(prtypac.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = dir_pac_party_committee)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7)

int_prtypac.fit <- sampling(int_prtypac.model,
                            chains = 4,
                            cores = 4,
                            iter = 8000,
                            warmup = 4000,
                            data = stan.data)

traceplot(int_prtypac.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_int", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

precis(int_prtypac.fit, prob = 0.89, digits = 3)

post <- spread_draws(int_prtypac.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = dir_pac_party_committee)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7)
```


## Model of Self-finance Contributions

### Simulating Priors

```{r}
# likelihood simulation
ggplot() +
  geom_density(data = as_tibble(rgamma(1e4, shape = 20, rate = 100)), 
               aes(x = value)) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) 

# prior simulation
## Intercept
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(10), exp(11))),
               aes(x = value, fill = "Normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Intercept") +
  scale_x_continuous(labels = dollar_format()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

## Slope Parameters
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(0), exp(11))),
               aes(x = value, fill = "normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(labels = dollar_format()) 

## Scale Parameter
ggplot() +
  geom_density(data = as_tibble(rexp(1e4, 1)), 
               aes(x = value, fill = "rate=1")) +
  geom_density(data = as_tibble(rexp(1e4, 2)), 
               aes(x = value, fill = "rate=2"), 
               alpha = 0.5) +
  theme_classic() +
  labs(x = "Mean and SD of Scale Parameter")

## Probability Parameter
ggplot() +
  geom_density(data = as_tibble(runif(1e4, 0, 1)), 
               aes(x = value, fill = "uniform")) +
  geom_density(data = as_tibble(rbeta(1e4, 2, 2)), 
               aes(x = value, fill = "beta 2"), 
               alpha = 0.5) +
    geom_density(data = as_tibble(rbeta(1e4, 1.5, 1.5)), 
               aes(x = value, fill = "beta 1.5"), 
               alpha = 0.7) +
  theme_classic() +
  labs(x = "Mean and SD of Probability Parameter")
```

### Model 

```{stan output.var = "slffin.model"}
data {
  int<lower = 1> n;
  real indiv_self_finance[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real<lower = 0, upper = 1> prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(10, 11);
  b_np ~ normal(0, 11);
  b_new ~ normal(0, 11);
  b_white ~ normal(0, 11);
  b_black ~ normal(0, 11);
  b_latino ~ normal(0, 11);
  b_asian ~ normal(0, 11);
  b_bach ~ normal(0, 11);
  b_clint ~ normal(0, 11);
  b_house ~ normal(0, 11);
  b_vpop ~ normal(0, 11);
  b_mhh ~ normal(0, 11);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (indiv_self_finance[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(indiv_self_finance[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

```{stan output.var = "int_slffin.model"}
data {
  int<lower = 1> n;
  real indiv_self_finance[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_int;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real<lower = 0, upper = 1> prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] +
      b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(10, 11);
  b_np ~ normal(0, 11);
  b_new ~ normal(0, 11);
  b_int ~ normal(0, 11);
  b_white ~ normal(0, 11);
  b_black ~ normal(0, 11);
  b_latino ~ normal(0, 11);
  b_asian ~ normal(0, 11);
  b_bach ~ normal(0, 11);
  b_clint ~ normal(0, 11);
  b_house ~ normal(0, 11);
  b_vpop ~ normal(0, 11);
  b_mhh ~ normal(0, 11);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (indiv_self_finance[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(indiv_self_finance[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] +
      b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

### Estimation

```{r}
# compose data
stan.data <- 
  estimation.data %>%
  dplyr::select(indiv_self_finance, no_corp_pacs, new_member, pct_white, pct_black, 
                pct_latino, pct_asian, pct_bachelors, pct_clinton_16,
                pct_dem_house_16, log_tot_voting_age, log_median_hh_income) %>%
  mutate(no_corp_pacs = ifelse(no_corp_pacs == "YES", 1, 0),
         new_member = ifelse(new_member == "YES", 1, 0)) %>%
  drop_na() %>%
  mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center) %>%
  compose_data()

# model estimation ------------------------------------------------------------
## Frequentist
# self.contribs.01 <- glm(indiv_self_finance ~ no_corp_pacs + new_member + pct_white + pct_black + pct_latino + pct_asian + pct_bachelors + pct_clinton_16 + pct_dem_house_16 + log_median_hh_income + log_tot_voting_age,
#                      family = Gamma(link = "log"),
#                      data = as.data.frame(stan.data) %>% filter(indiv_self_finance != 0) %>% mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center))

## Bayesian
slffin.fit <- sampling(slffin.model,
                       chains = 4,
                       cores = 4,
                       iter = 25000,
                       warmup = 12000,
                       data = stan.data)

traceplot(slffin.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

#tidy(self.contribs.01, conf.int = TRUE, conf.level = 0.89, digits = 3)
precis(slffin.fit, prob = 0.89, digits = 3)

post <- spread_draws(slffin.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = indiv_self_finance)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7) +
  xlim(0, 100)

int_slffin.fit <- sampling(int_slffin.model,
                           chains = 4,
                           cores = 4,
                           iter = 25000,
                           warmup = 12000,
                           data = stan.data)

traceplot(int_slffin.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_int", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

precis(int_slffin.fit, prob = 0.89, digits = 3)

post <- spread_draws(int_slffin.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = indiv_self_finance)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7) +
  xlim(0, 100)
```


## Model of Contributions from other Candidates

### Simulating Priors

```{r}
# likelihood simulation
ggplot() +
  geom_density(data = as_tibble(rgamma(1e4, shape = 20, rate = 100)), 
               aes(x = value)) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) 

# prior simulation
## Intercept
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(8), exp(10))),
               aes(x = value, fill = "Normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Intercept") +
  scale_x_continuous(labels = dollar_format()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

## Slope Parameters
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(0), exp(10))),
               aes(x = value, fill = "normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(labels = dollar_format()) 

## Scale Parameter
ggplot() +
  geom_density(data = as_tibble(rexp(1e4, 1)), 
               aes(x = value, fill = "rate=1")) +
  geom_density(data = as_tibble(rexp(1e4, 2)), 
               aes(x = value, fill = "rate=2"), 
               alpha = 0.5) +
  theme_classic() +
  labs(x = "Mean and SD of Scale Parameter")

## Probability Parameter
ggplot() +
  geom_density(data = as_tibble(runif(1e4, 0, 1)), 
               aes(x = value, fill = "uniform")) +
  geom_density(data = as_tibble(rbeta(1e4, 1, 2)), 
               aes(x = value, fill = "beta 2"), 
               alpha = 0.5) +
    geom_density(data = as_tibble(rbeta(1e4, 1.5, 1.5)), 
               aes(x = value, fill = "beta 1.5"), 
               alpha = 0.7) +
  theme_classic() +
  labs(x = "Mean and SD of Probability Parameter")
```

### Model 

```{stan output.var = "candcontribs.model"}
data {
  int<lower = 1> n;
  real candidate_contribs[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real<lower = 0, upper = 1> prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(8, 10);
  b_np ~ normal(0, 10);
  b_new ~ normal(0, 10);
  b_white ~ normal(0, 10);
  b_black ~ normal(0, 10);
  b_latino ~ normal(0, 10);
  b_asian ~ normal(0, 10);
  b_bach ~ normal(0, 10);
  b_clint ~ normal(0, 10);
  b_house ~ normal(0, 10);
  b_vpop ~ normal(0, 10);
  b_mhh ~ normal(0, 10);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (candidate_contribs[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(candidate_contribs[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

```{stan output.var = "int_candcontribs.model"}
data {
  int<lower = 1> n;
  real candidate_contribs[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_int;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real<lower = 0, upper = 1> prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] +
      b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(8, 10);
  b_np ~ normal(0, 10);
  b_new ~ normal(0, 10);
  b_int ~ normal(0, 10);
  b_white ~ normal(0, 10);
  b_black ~ normal(0, 10);
  b_latino ~ normal(0, 10);
  b_asian ~ normal(0, 10);
  b_bach ~ normal(0, 10);
  b_clint ~ normal(0, 10);
  b_house ~ normal(0, 10);
  b_vpop ~ normal(0, 10);
  b_mhh ~ normal(0, 10);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (candidate_contribs[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(candidate_contribs[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] +
      b_int * (no_corp_pacs[i] * new_member[i]) +
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

### Estimation

```{r}
# compose data
stan.data <- 
  estimation.data %>%
  dplyr::select(candidate_contribs, no_corp_pacs, new_member, pct_white, pct_black, 
                pct_latino, pct_asian, pct_bachelors, pct_clinton_16,
                pct_dem_house_16, log_tot_voting_age, log_median_hh_income) %>%
  mutate(no_corp_pacs = ifelse(no_corp_pacs == "YES", 1, 0),
         new_member = ifelse(new_member == "YES", 1, 0)) %>%
  drop_na() %>%
  mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center) %>%
  compose_data()

# model estimation ------------------------------------------------------------
## Frequentist
# cand.contribs.01 <- glm(candidate_contribs ~ no_corp_pacs + new_member + pct_white + pct_black + pct_latino + pct_asian + pct_bachelors + pct_clinton_16 + pct_dem_house_16 + log_median_hh_income + log_tot_voting_age,
#                         family = Gamma(link = "log"),
#                         data = as.data.frame(stan.data) %>% filter(candidate_contribs != 0) %>% mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center))

## Bayesian
candcontribs.fit <- sampling(candcontribs.model,
                             chains = 4,
                             cores = 4,
                             iter = 25000,
                             warmup = 12000,
                             data = stan.data)

traceplot(candcontribs.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

#tidy(cand.contribs.01, conf.int = TRUE, conf.level = 0.89, digits = 3)
precis(candcontribs.fit, prob = 0.89, digits = 3)

post <- spread_draws(candcontribs.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = candidate_contribs)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7) +
  xlim(0, 100)

int_candcontribs.fit <- sampling(int_candcontribs.model,
                                 chains = 4,
                                 cores = 4,
                                 iter = 25000,
                                 warmup = 12000,
                                 data = stan.data)

traceplot(int_candcontribs.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_int", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

#tidy(cand.contribs.01, conf.int = TRUE, conf.level = 0.89, digits = 3)
precis(int_candcontribs.fit, prob = 0.89, digits = 3)

post <- spread_draws(int_candcontribs.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = candidate_contribs)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7) +
  xlim(0, 100)
```


# Individual Models

## Model of Small Individual Contributions

### Simulating Priors

```{r}
# likelihood simulation
ggplot() +
  geom_density(data = as_tibble(rgamma(1e4, shape = 20, rate = 100)), 
               aes(x = value)) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) 

# prior simulation
## Intercept
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(10), exp(14))),
               aes(x = value, fill = "Normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Intercept") +
  scale_x_continuous(labels = dollar_format()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

## Slope Parameters
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(0), exp(13))),
               aes(x = value, fill = "normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(labels = dollar_format()) 

## Scale Parameter
ggplot() +
  geom_density(data = as_tibble(rexp(1e4, 1)), 
               aes(x = value, fill = "rate=1")) +
  geom_density(data = as_tibble(rexp(1e4, 2)), 
               aes(x = value, fill = "rate=2"), 
               alpha = 0.5) +
  theme_classic() +
  labs(x = "Mean and SD of Scale Parameter")

## Probability Parameter
ggplot() +
  geom_density(data = as_tibble(runif(1e4, 0, 1)), 
               aes(x = value, fill = "uniform")) +
  geom_density(data = as_tibble(rbeta(1e4, 2, 2)), 
               aes(x = value, fill = "beta 2"), 
               alpha = 0.5) +
    geom_density(data = as_tibble(rbeta(1e4, 1.5, 1.5)), 
               aes(x = value, fill = "beta 1.5"), 
               alpha = 0.7) +
  theme_classic() +
  labs(x = "Mean and SD of Probability Parameter")
```

### Model 

```{stan output.var = "smlindv.model"}
data {
  int<lower = 1> n;
  real small_indiv[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(10, 14);
  b_np ~ normal(0, 13);
  b_new ~ normal(0, 13);
  b_white ~ normal(0, 13);
  b_black ~ normal(0, 13);
  b_latino ~ normal(0, 13);
  b_asian ~ normal(0, 13);
  b_bach ~ normal(0, 13);
  b_clint ~ normal(0, 13);
  b_house ~ normal(0, 13);
  b_vpop ~ normal(0, 13);
  b_mhh ~ normal(0, 13);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (small_indiv[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(small_indiv[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

### Estimation

```{r}
# compose data
stan.data <- 
  estimation.data %>%
  dplyr::select(small_indiv, no_corp_pacs, new_member, pct_white, pct_black, 
                pct_latino, pct_asian, pct_bachelors, pct_clinton_16,
                pct_dem_house_16, log_tot_voting_age, log_median_hh_income) %>%
  mutate(no_corp_pacs = ifelse(no_corp_pacs == "YES", 1, 0),
         new_member = ifelse(new_member == "YES", 1, 0)) %>%
  drop_na() %>%
  mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center) %>%
  compose_data()

# model estimation ------------------------------------------------------------
## Frequentist
small.01 <- glm(small_indiv ~ no_corp_pacs + new_member + pct_white + pct_black + pct_latino + pct_asian + pct_bachelors + pct_clinton_16 + pct_dem_house_16 + log_median_hh_income + log_tot_voting_age,
                     family = Gamma(link = "log"),
                     data = as.data.frame(stan.data) %>% filter(small_indiv != 0) %>% mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center))

## Bayesian
smlindv.fit <- sampling(smlindv.model,
                        chains = 4,
                        cores = 4,
                        iter = 8000,
                        warmup = 4000,
                        data = stan.data)

traceplot(smlindv.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

tidy(small.01, conf.int = TRUE, conf.level = 0.89, digits = 3)
precis(smlindv.fit, prob = 0.89, digits = 3)

post <- spread_draws(smlindv.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = small_indiv)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7)
```


## Model of Large Individual Contributions

### Simulating Priors

```{r}
# likelihood simulation
ggplot() +
  geom_density(data = as_tibble(rgamma(1e4, shape = 20, rate = 100)), 
               aes(x = value)) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) 

# prior simulation
## Intercept
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(11), exp(14))),
               aes(x = value, fill = "Normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Intercept") +
  scale_x_continuous(labels = dollar_format()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

## Slope Parameters
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(0), exp(13))),
               aes(x = value, fill = "normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(labels = dollar_format()) 

## Scale Parameter
ggplot() +
  geom_density(data = as_tibble(rexp(1e4, 1)), 
               aes(x = value, fill = "rate=1")) +
  geom_density(data = as_tibble(rexp(1e4, 2)), 
               aes(x = value, fill = "rate=2"), 
               alpha = 0.5) +
  theme_classic() +
  labs(x = "Mean and SD of Scale Parameter")

## Probability Parameter
ggplot() +
  geom_density(data = as_tibble(runif(1e4, 0, 1)), 
               aes(x = value, fill = "uniform")) +
  geom_density(data = as_tibble(rbeta(1e4, 2, 2)), 
               aes(x = value, fill = "beta 2"), 
               alpha = 0.5) +
    geom_density(data = as_tibble(rbeta(1e4, 1.5, 1.5)), 
               aes(x = value, fill = "beta 1.5"), 
               alpha = 0.7) +
  theme_classic() +
  labs(x = "Mean and SD of Probability Parameter")
```

### Model 

```{stan output.var = "lrgindv.model"}
data {
  int<lower = 1> n;
  real large_indiv[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(11, 14);
  b_np ~ normal(0, 13);
  b_new ~ normal(0, 13);
  b_white ~ normal(0, 13);
  b_black ~ normal(0, 13);
  b_latino ~ normal(0, 13);
  b_asian ~ normal(0, 13);
  b_bach ~ normal(0, 13);
  b_clint ~ normal(0, 13);
  b_house ~ normal(0, 13);
  b_vpop ~ normal(0, 13);
  b_mhh ~ normal(0, 13);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (large_indiv[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(large_indiv[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

### Estimation

```{r}
# compose data
stan.data <- 
  estimation.data %>%
  dplyr::select(large_indiv, no_corp_pacs, new_member, pct_white, pct_black, 
                pct_latino, pct_asian, pct_bachelors, pct_clinton_16,
                pct_dem_house_16, log_tot_voting_age, log_median_hh_income) %>%
  mutate(no_corp_pacs = ifelse(no_corp_pacs == "YES", 1, 0),
         new_member = ifelse(new_member == "YES", 1, 0)) %>%
  drop_na() %>%
  mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center) %>%
  compose_data()

# model estimation ------------------------------------------------------------
## Frequentist
large.01 <- glm(large_indiv ~ no_corp_pacs + new_member + pct_white + pct_black + pct_latino + pct_asian + pct_bachelors + pct_clinton_16 + pct_dem_house_16 + log_median_hh_income + log_tot_voting_age,
                     family = Gamma(link = "log"),
                     data = as.data.frame(stan.data) %>% filter(large_indiv != 0) %>% mutate_at(.vars = vars(pct_white:log_median_hh_income), .funs = center))

## Bayesian
lrgindv.fit <- sampling(lrgindv.model,
                        chains = 4,
                        cores = 4,
                        iter = 8000,
                        warmup = 4000,
                        data = stan.data)

traceplot(lrgindv.fit, 
          inc_warmup = TRUE, 
          pars = c("a", "b_np", "b_new", "b_white", "b_black", "b_latino", 
                   "b_asian", "b_bach", "b_clint", "b_house", "b_vpop", 
                   "b_mhh", "scale"))

tidy(large.01, conf.int = TRUE, conf.level = 0.89, digits = 3)
precis(lrgindv.fit, prob = 0.89, digits = 3)

post <- spread_draws(lrgindv.fit, mu[i]) %>% median_hdi()
ggplot(data = estimation.data, aes(x = small_indiv)) +
  geom_density(fill = "gray") +
  geom_density(data = post, aes(x = mu), fill = "skyblue", alpha = 0.7)
```


## Model of Total Individual Contributions

### Simulating Priors

```{r}
# likelihood simulation
ggplot() +
  geom_density(data = as_tibble(rgamma(1e4, shape = 20, rate = 100)), 
               aes(x = value)) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) 

# prior simulation
## Intercept
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(12), exp(14))),
               aes(x = value, fill = "Normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Intercept") +
  scale_x_continuous(labels = dollar_format()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

## Slope Parameters
ggplot() +
  geom_density(data = as_tibble(rnorm(1e4, exp(0), exp(14))),
               aes(x = value, fill = "normal")) +
  theme_classic() +
  labs(x = "Mean and SD of Slope Parameters") +
  scale_x_continuous(labels = dollar_format()) 

## Scale Parameter
ggplot() +
  geom_density(data = as_tibble(rexp(1e4, 1)), 
               aes(x = value, fill = "rate=1")) +
  geom_density(data = as_tibble(rexp(1e4, 2)), 
               aes(x = value, fill = "rate=2"), 
               alpha = 0.5) +
  theme_classic() +
  labs(x = "Mean and SD of Scale Parameter")

## Probability Parameter
ggplot() +
  geom_density(data = as_tibble(runif(1e4, 0, 1)), 
               aes(x = value, fill = "uniform")) +
  geom_density(data = as_tibble(rbeta(1e4, 2, 2)), 
               aes(x = value, fill = "beta 2"), 
               alpha = 0.5) +
    geom_density(data = as_tibble(rbeta(1e4, 1.5, 1.5)), 
               aes(x = value, fill = "beta 1.5"), 
               alpha = 0.7) +
  theme_classic() +
  labs(x = "Mean and SD of Probability Parameter")
```

### Model 

```{stan output.var = "totindv.model"}
data {
  int<lower = 1> n;
  real net_indiv_total[n];
  int no_corp_pacs[n];
  int new_member[n];
  real pct_white[n];
  real pct_black[n];
  real pct_latino[n];
  real pct_asian[n];
  real pct_bachelors[n];
  real pct_clinton_16[n];
  real pct_dem_house_16[n];
  real log_median_hh_income[n];
  real log_tot_voting_age[n];
}

parameters {
  real<lower = 0> a;
  real b_np;
  real b_new;
  real b_white;
  real b_black;
  real b_latino;
  real b_asian;
  real b_bach;
  real b_mhh;
  real b_clint;
  real b_house;
  real b_vpop;
  real<lower = 0> scale;
  real prob;
}

model {
  // linear model
  vector[n] mu;
  for (i in 1:n) {
    mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
    mu[i] = exp(mu[i]); // inverse link function
  }
  
  // priors
  a ~ normal(12, 14);
  b_np ~ normal(0, 14);
  b_new ~ normal(0, 14);
  b_white ~ normal(0, 14);
  b_black ~ normal(0, 14);
  b_latino ~ normal(0, 14);
  b_asian ~ normal(0, 14);
  b_bach ~ normal(0, 14);
  b_clint ~ normal(0, 14);
  b_house ~ normal(0, 14);
  b_vpop ~ normal(0, 14);
  b_mhh ~ normal(0, 14);
  scale ~ exponential(2);
  prob ~ beta(1.5, 1.5);
  
  // likelihood
  for ( i in 1:n) {
    if (net_indiv_total[i] == 0)
      target += (bernoulli_lpmf(1| prob));
    else
      target += (bernoulli_lpmf(0| prob) + gamma_lpdf(net_indiv_total[i]| mu[i]/scale, 1/scale));
    }//i
}

generated quantities {
  vector[n] mu;
  
  for (i in 1:n) {
  mu[i] = a + b_np * no_corp_pacs[i] + b_new * new_member[i] + 
      b_white * pct_white[i] + b_black * pct_black[i] + 
      b_latino * pct_latino[i] + b_asian * pct_asian[i] + 
      b_bach * pct_bachelors[i] + b_clint * pct_clinton_16[i] + 
      b_house * pct_dem_house_16[i] + b_mhh * log_median_hh_income[i] +
      b_vpop * log_tot_voting_age[i];
  mu[i] = exp(mu[i]); // inverse link function
  }
}
```

### Estimation

```{r}
# compose data
stan.data <- 
>>>>>>> parent of 6f7fbd8 (calculating in vs out of state contributions)
  estimation.data %>%
  mutate(tot_contribs = business_pacs + small_indiv + biz_contribs + 
           out_of_dist_biz_contrib,
         biz_pac_prop = business_pacs / tot_contribs,
         small_indiv_prop = small_indiv / tot_contribs,
         biz_contribs_prop = biz_contribs / tot_contribs,
         out_of_dist_biz_contrib_prop = out_of_dist_biz_contrib / tot_contribs,
         sum = biz_pac_prop + biz_contribs_prop + small_indiv_prop + 
           out_of_dist_biz_contrib_prop)

dir.estimation.data <- 
  estimation.data %>%
  filter(biz_pac_prop != 0) %>%
  filter(small_indiv_prop != 0) %>%
  filter(biz_contribs_prop != 0) %>%
  filter(out_of_dist_biz_contrib_prop != 0)

dir.estimation.data$y <- 
  with(dir.estimation.data, cbind(biz_pac_prop, small_indiv_prop, 
                                  biz_contribs_prop, 
                                  out_of_dist_biz_contrib_prop))

dir.fit <- brm(y ~ no_corp_pacs + new_member + pct_white_c +
                 pct_black_c + pct_latino_c + pct_asian_c + 
                 pct_bachelors_c + pct_clinton_16_c + 
                 pct_dem_house_16_c + log_tot_voting_age_c +
                 log_median_hh_income_c,
               family = dirichlet(link = "logit"),
               cores = 4,
               iter = 4000,
               backend = "cmdstanr",
               data = dir.estimation.data)
describe_posterior(dir.fit, ci = 0.9, ci_method = "hdi",
                   test = c("p_direction"))

ce <- conditional_effects(dir.fit, categorical = T, effects = "no_corp_pacs", 
                          prob = 0.9, method = "posterior_epred")[[1]]

ggplot(data = ce, aes(x = no_corp_pacs, y = estimate__, ymin = lower__,
                      ymax = upper__, shape = cats__, color = cats__)) +
  geom_point(position = position_dodge(width = 0.5), size = 4.5) +
  geom_errorbar(position = position_dodge(width = 0.5), width = 0.2) +
  scale_color_manual(values = c("gray62", "gray38", "grey20", "black"),
                     labels = c("Business PACs", "Small Individual", 
                                "Business Individual", 
                                "Out-of-District Business Indiv.")) +
  scale_shape_manual(values = c(15, 19, 17, 18),
                     labels = c("Business PACs", "Small Individual", 
                                "Business Individual", 
                                "Out-of-District Business Indiv.")) +
  labs(x = "Candidate Accepts Corporate PAC Contributions?",
       y = "Proportion of Contributions",
       color = "Contributions from:",
       shape = "Contributions from:") +
  scale_x_discrete(labels = c("Yes", "No")) +
  scale_y_continuous(labels = percent_format(), limits = c(0, 0.6),
                     breaks = pretty_breaks(n = 6)) +
  theme_pubclean()
ggsave("Figures/dir_model_results.pdf", plot = last_plot(),
       width = 9, height = 5)
```