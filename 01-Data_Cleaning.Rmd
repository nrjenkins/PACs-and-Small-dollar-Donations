---
title: "Step I: Data Cleaning"
subtitle: "Project.title"
author:
  - name: Nicholas R. Jenkins 
    affiliation: University of California, Riverside
    affiliation_url: https://www.ucr.edu
description: |
  This document shows all the code used to clean the data for this project. 
  Each step has been carefully documented and will replicate the data set used
  in the study. For any questions about this code, please contact 
  Nick Jenkins at [nicholas.jenkins@email.ucr.edu](mailto:nicholas.jenkins@email.ucr.edu).
abstract: |
  This document shows all the code used to clean the data for this project. 
  Each step has been carefully documented and will replicate the data set used
  in the study. For any questions about this code, please contact 
  Nick Jenkins at [nicholas.jenkins@email.ucr.edu](mailto:nicholas.jenkins@email.ucr.edu).
date: "`r Sys.Date()`"
output: 
  radix: radix::radix_article
  html_notebook: 
    highlight: monochrome
    theme: simplex
    toc: yes
    code_folding: 
  html_document:
    highlight: monochrome
    theme: simplex
    toc: yes
    code_folding:
  pdf_document:
    toc: yes
  github_document:
    toc: yes
#bibliography: /Users/nick/Documents/Research/References/BibTeX/biblatex.bib
editor_options: 
  chunk_output_type: console
---

# Environment Preperation

This section clears the current working environment and loads the packages used to clean the data. I also create the function `comma()` to format any in-line output values to have thousands separators and only two digits. 

```{r setup, warning = FALSE, message = FALSE, results = "hide", echo = TRUE}
# Clear Environment -----------------------------------------------------------
rm(list = ls())

# Load Packages ---------------------------------------------------------------
packages <- c("tidyverse", "stargazer", "foreign", "sqldf", "readxl", 
              "openintro", "lubridate")
lapply(packages, require, character.only = TRUE)

# Inline Formatting -----------------------------------------------------------
comma <- function(x) format(x, digits = 2, big.mark = ",")
```


# Legislator Data

```{r}
members.2018.data.raw <- read_xlsx("Data/Raw Data/OpenSecrets.org _ No Corp PAC Members.xlsx", 
                                   skip = 1,
                                   sheet = "All Cands 2018")
members.2018.data <- 
  members.2018.data.raw %>%
  mutate(NoCorpPACs = as_factor(NoCorpPACs),
         Party = as_factor(Party),
         Party = relevel(Party, ref = "I")) %>%
  rename(new_member = `New Member?`,
         no_corp_pacs = NoCorpPACs,
         opensecrets_id = `Candidate ID`,
         candidae_name = CRPName,
         party = Party,
         district = District,
         gen_election_result = `General Elec Result`,
         vote_pct = VotePercent,
         tot_pac_money = `Total PAC Money`,
         num_pac_contribs = `Number of PAC Contributions`,
         business_pacs = `Business PACs`,
         labor_pacs = `Labor PACs`,
         ideological_pacs = `Ideological PACs`,
         leadership_pacs = `Lead PACs`,
         other_pacs = `Other PACs`,
         net_receipts = `Net Receipts`,
         net_indiv_total = `Net Individual Total`,
         candidate_contribs = `Candidate Contributions`,
         large_indiv = `Large Indivs`,
         small_indiv = `Small Indivs`,
         net_spent = `Net Spent`) %>%
  separate(candidae_name, into = c("first_name", "last_name"), extra = "drop") %>%
  mutate(first_initial = str_sub(first_name, start = 1L, end = 1L),
         last_stub = str_sub(last_name, start = 1L, end = 3L))
```


# Demographic Data

```{r}
demo.data.raw <- read_excel("Data/Raw Data/Demographic Data/115th Congress Members Guide with Elections and Demographic Data by District.xlsx",
                            sheet = "House - Working")

demo.data <- 
  demo.data.raw %>%
  mutate(district_code = str_replace(district_code, pattern = "-", replacement = ""),
         district_code = ifelse(district == "Alaska At-Large", "AK01", district_code),
         district_code = ifelse(district == "Delaware At-Large", "DE01", district_code),
         district_code = ifelse(district == "Montana At-Large", "MT01", district_code),
         district_code = ifelse(district == "North Dakota At-Large", "ND01", district_code),
         district_code = ifelse(district == "South Dakota At-Large", "SD01", district_code),
         district_code = ifelse(district == "Vermont At-Large", "VT01", district_code),
         district_code = ifelse(district == "Wyoming At-Large", "WY01", district_code)) %>%
  rename(state_dist = district_code)

# total voting age pop
library(tidycensus)
census_api_key("b52b951af88427dcca3cee53db4fb1f76da8009d", install = TRUE, overwrite = TRUE)

v18 <- load_variables(year = 2017, dataset = "acs5/subject", cache = TRUE)
	
voting.age <- get_acs(geography = "congressional district", 
                      variables = "S0101_C01_026",
                      key = "b52b951af88427dcca3cee53db4fb1f76da8009d")
voting_age <- 
  voting.age %>%
  rename(tot_voting_age = estimate) %>%
  separate(NAME,
           into = c("district", "state"),
           sep = ",",
           extra = "merge") %>%
  mutate(district = str_replace(district, "\\(115th Congress\\)", ""),
         district = str_replace(district, "Congressional District ", ""),
         district = str_trim(district, side = "both"),
         district = str_pad(district, width = 2, side = "left", pad = "0"),
         state = str_trim(state, side = "both"),
         state_dist = paste(state2abbr(state), district, sep = ""),
         state_dist = str_replace(state_dist, pattern = "\\(at Large\\)", "01")) %>%
  dplyr::select(-variable, -moe, -GEOID, -district, -state)

demo.data <- left_join(
  demo.data,
  voting_age,
  by = c("state_dist")
)
```

## Merge legislator data with demographics

```{r}
sum(duplicated(members.2018.data[ , c("district")]))
sum(duplicated(demo.data[ , c("district")]))

member.data <- left_join(
  members.2018.data,
  demo.data,
  by = c("district" = "state_dist")
)
```

# Election Data

```{r}
election.data.raw <- read_csv("/Users/nick/Documents/Research/Projects/PACs and Small-dollar Donations/Data/Raw Data/Election Data/1976-2018-house.csv") %>% filter(year == 2018) %>% filter(stage == "gen")

election.data <- 
  election.data.raw %>%
  mutate(district = str_pad(district, width = 2, side = "left", pad = "0"),
         vote_pct = candidatevotes / totalvotes,
         first_initial = str_sub(candidate, start = 1L, end = 1L)) %>%
  filter(!is.na(candidate)) %>%
  separate(candidate, into = c("first_name", "last_name"), extra = "drop") %>%
  mutate(last_stub = str_sub(last_name, start = 1L, end = 3L),
         state_dist = paste(state_po, district, sep = ""),
         party = case_when(party == "democrat" ~ "D",
                           party == "republican" ~ "R")) %>%
  filter(!is.na(party)) %>%
  dplyr::select(state_dist, party, first_initial, first_name, last_name, last_stub,
         candidatevotes, totalvotes, office)

election.data <- 
  election.data %>%
  mutate(state_dist = ifelse(state_dist == "AK00", "AK01", state_dist),
         state_dist = ifelse(state_dist == "DE00", "DE01", state_dist),
         state_dist = ifelse(state_dist == "MT00", "MT01", state_dist),
         state_dist = ifelse(state_dist == "ND00", "ND01", state_dist),
         state_dist = ifelse(state_dist == "SD00", "SD01", state_dist),
         state_dist = ifelse(state_dist == "VT00", "VT01", state_dist),
         state_dist = ifelse(state_dist == "WY00", "WY01", state_dist))
```

## Merge Election Data with Contribution Data

```{r}
sum(duplicated(election.data[ , c("state_dist", "party", "first_initial", "last_stub")]))
sum(duplicated(member.data[ , c("district", "party", "first_initial", "last_stub")]))

member.data <- left_join(
  member.data,
  election.data,
  by = c("district" = "state_dist", "party", "first_initial", "last_stub")
)

member.data <- 
  member.data %>%
  mutate(new_member = as_factor(new_member),
         party = as_factor(party),
         vap_turnout = candidatevotes / tot_voting_age) %>%
  dplyr::select(opensecrets_id, first_name.x, last_name.x, district, party, 
                new_member, no_corp_pacs, tot_pac_money, num_pac_contribs, 
                business_pacs, labor_pacs, ideological_pacs, leadership_pacs, 
                other_pacs, net_receipts, net_indiv_total, candidate_contribs, 
                large_indiv, small_indiv, net_spent, vote_pct, vap_turnout, 
                median_hh_income, pct_clinton_16, pct_obama_12, 
                pct_dem_house_16,pct_dem_house_14, pct_asian, pct_white, 
                pct_black, pct_latino, pct_bachelors, tot_voting_age, office) %>%
  filter(!is.na(office)) %>%
  dplyr::select(-office) %>%
  rename(first_name = first_name.x,
         last_name = last_name.x)
```


# Contribution Data

```{r}
## Industry Categories
industry.cats <- read_excel("/Users/nick/Documents/Research/Projects/Contributions and Committee Requests/Data/Raw Data/CRP_industry_codes.xlsx")
industry.cats <- 
  industry.cats %>%
  filter(str_detect(Catcode, "0000")) %>%
  mutate(industry_letter = str_sub(Catcode, start = 1L, end = 1L)) %>%
  select(-Catcode, -Catorder)

# Individual Contributions
indiv.contrib.data.raw <- 
  read_delim("/Users/nick/Documents/Research/Projects/Contributions and Committee Requests/Data/Raw Data/Contribution Data/CampaignFin18/indivs18.txt", 
                       delim = "|, |",
                       col_names = FALSE) %>%
    rename(year = X2,
         fec_trans_id = X4,
         donor_id = X6,
         contrib_name = X8,
         receipt_id = X10,
         donor_org_name = X12,
         standard_org = X14,
         industry_code = X16,
         contrib_date = X17,
         contrib_city = X20,
         contrib_state = X22, 
         contrib_zip = X24) %>%
  select(year, fec_trans_id, donor_id, contrib_name, receipt_id, 
         donor_org_name, standard_org, industry_code, contrib_date) %>%
  separate(contrib_date, into = c("drop", "contrib_date", "contrib_amount"), sep = ",") %>%
  mutate(fec_trans_id = as.character(fec_trans_id),
         contrib_amount = as.numeric(contrib_amount),
         contrib_date = mdy(contrib_date)) %>%
  group_by(receipt_id, industry_code) %>%
  summarise(year = first(year),
            contrib_amount = sum(contrib_amount)) %>%
  mutate(contrib_type = "Individual") %>%
  arrange(receipt_id, industry_code, year)

indiv.contrib.data <- 
  indiv.contrib.data.raw %>%
  mutate(industry_code = str_to_upper(industry_code),
         industry_letter = str_sub(industry_code, start = 1L, end = 1L)) %>%
  filter(industry_code != "Z9100") %>%
  filter(industry_code != "Z9500") %>%
  filter(industry_code != "Z9600") %>%
  filter(industry_code != "Z9700") %>%
  filter(industry_code != "Z9800") %>%
  filter(industry_code != "Z9999") %>%
  mutate(industry_letter = ifelse(industry_code == "Z1000" | 
                                    industry_code == "Z1100" | 
                                    industry_code == "Z1200" |
                                    industry_code == "Z1300" |
                                    industry_code == "Z1400", "CC", industry_letter),
         industry_letter = ifelse(industry_code == "Z4100" | 
                                    industry_code == "Z4200" | 
                                    industry_code == "Z4300" |
                                    industry_code == "Z4400" |
                                    industry_code == "Z4500", "JCC", industry_letter),
         industry_letter = ifelse(industry_code == "Z5000" | 
                                    industry_code == "Z5100" | 
                                    industry_code == "Z5200" |
                                    industry_code == "Z5300", "PC", industry_letter),
         industry_letter = ifelse(industry_code == "Z9000", "Self-finance", industry_letter)) %>%
  group_by(receipt_id, industry_letter) %>%
  summarise(contrib_amount = sum(contrib_amount)) %>%
  arrange(receipt_id, industry_letter)

## Merge with contribution data
indiv.contrib.data <- left_join(
  indiv.contrib.data,
  industry.cats,
  by = c("industry_letter")
)

indiv.contrib.data <- 
  indiv.contrib.data %>%
  mutate(Catname = ifelse(industry_letter == "Z", "Committees", Catname)) %>%
  rename(industry_name = Catname,
         industry = Industry,
         sector = Sector,
         sector_long = `Sector Long`)

indiv.contrib.data <- 
  indiv.contrib.data %>%
  mutate(industry_name = ifelse(industry_letter == "Self-finance", 
                                "indiv_self_finance",
                                industry_name),
         industry_name = ifelse(industry_letter == "CC", 
                                "indiv_cand_committee",
                                industry_name),
         industry_name = ifelse(industry_letter == "JCC", 
                                "indiv_jnt_cand_committee",
                                industry_name),
         industry_name = ifelse(industry_letter == "PC", 
                                "indiv_party_committee",
                                industry_name))

sum(duplicated(indiv.contrib.data[ , c("receipt_id", "industry_letter")]))

indiv.contrib.data <- 
  indiv.contrib.data %>%
  filter(!is.na(industry_name)) %>%
  select(receipt_id, industry_name, contrib_amount) %>%
  spread(key = industry_name, value = contrib_amount) %>%
  rename(indiv_ag = Agriculture,
         indiv_comms_electric = `Communications & Electronics`,
         indiv_const_pub_wrks = `Construction & Public Works`,
         indiv_defense = Defense,
         indiv_engy_res_envrmt = `Energy, Natural Resources and Environment`,
         indiv_fncs_ins_real = `Finance, Insurance & Real Estate`,
         indiv_commerce = `General commerce`,
         indiv_hlth_edu_human = `Health, Education & Human Resources`,
         indiv_ideological = `Ideological & Single Issue PACs`,
         indiv_labor = `Labor Unions`,
         indiv_legal = `Legal Services`,
         indiv_manu = Manufacturing,
         indiv_other = Other,
         indiv_trans = Transportation,
         indiv_unknown = Unknown) %>%
  mutate_at(vars(indiv_ag:indiv_unknown), funs(ifelse(is.na(.), 0, .))) %>%
  arrange(receipt_id)

indiv.contrib.data$indiv_total <- rowSums(indiv.contrib.data[ , 3:20], na.rm = TRUE)

# PAC Contributions
## 2018 - Congress 116
pac.contrib.data.raw <- 
  read_delim("/Users/nick/Documents/Research/Projects/Contributions and Committee Requests/Data/Raw Data/Contribution Data/CampaignFin18/pacs18.txt", 
                       delim = "|, |",
                       col_names = FALSE) %>%
  rename(year = X2,
         fec_trans_id = X4,
         pac_id = X6,
         receipt_id = X8,
         industry_code = X10,
         trans_type = X12,
         direct_indirect = X14,
         contrib_date = X9) %>%
  select(year, fec_trans_id, pac_id, receipt_id, industry_code, trans_type, 
         direct_indirect, contrib_date) %>%
  separate(contrib_date, into = c("drop", "contrib_amount", "contrib_date"), sep = ",") %>%
  mutate(fec_trans_id = as.character(fec_trans_id),
         contrib_amount = as.numeric(contrib_amount),
         contrib_date = mdy(contrib_date),
         trans_type = factor(trans_type, 
                             levels = c("24A", "24C", "24E", "24F", "24K", "24N", "24Z"),
                             labels = c("independent expenditure against the candidate",
                                        "coordinated expenditure",
                                        "independent expenditure for the candidate",
                                        "communication cost for the candidate",
                                        "direct contribution",
                                        "communication cost against the candidate",
                                        "in kind contribution")),
         direct_indirect = factor(direct_indirect,
                                  levels = c("D", "I"),
                                  labels = c("Direct", "Indirect"))) %>%
  filter(trans_type == "coordinated expenditure" | 
           trans_type == "direct contribution" |
           trans_type == "in kind contribution") %>%
  filter(direct_indirect == "Direct") %>%
  mutate(contrib_type = "PAC") %>%
  arrange(receipt_id, industry_code, year)

pac.contrib.data <- 
  pac.contrib.data.raw %>%
  mutate(industry_code = str_to_upper(industry_code),
         industry_letter = str_sub(industry_code, start = 1L, end = 1L)) %>%
  filter(industry_code != "Z9100") %>%
  filter(industry_code != "Z9500") %>%
  filter(industry_code != "Z9600") %>%
  filter(industry_code != "Z9700") %>%
  filter(industry_code != "Z9800") %>%
  filter(industry_code != "Z9999") %>%
  mutate(industry_letter = ifelse(industry_code == "Z1000" | 
                                    industry_code == "Z1100" | 
                                    industry_code == "Z1200" |
                                    industry_code == "Z1300" |
                                    industry_code == "Z1400", "pac_cand_committee", industry_letter),
         industry_letter = ifelse(industry_code == "Z4100" | 
                                    industry_code == "Z4200" | 
                                    industry_code == "Z4300" |
                                    industry_code == "Z4400" |
                                    industry_code == "Z4500", "pac_jnt_cand_committee", industry_letter),
         industry_letter = ifelse(industry_code == "Z5000" | 
                                    industry_code == "Z5100" | 
                                    industry_code == "Z5200" |
                                    industry_code == "Z5300", "pac_party_committee", industry_letter),
         industry_letter = ifelse(industry_code == "Z9000", "Self-finance", industry_letter)) %>%
  group_by(receipt_id, industry_letter) %>%
  summarise(contrib_amount = sum(contrib_amount)) %>%
  arrange(receipt_id, industry_letter)

## Merge with contribution data
pac.contrib.data <- left_join(
  pac.contrib.data,
  industry.cats,
  by = c("industry_letter")
)

pac.contrib.data <- 
  pac.contrib.data %>%
  rename(industry_name = Catname,
         industry = Industry,
         sector = Sector,
         sector_long = `Sector Long`)

sum(duplicated(pac.contrib.data[ , c("receipt_id", "industry_letter")]))

pac.contrib.data <- 
  pac.contrib.data %>%
  filter(!is.na(industry_letter)) %>%
  select(receipt_id, contrib_amount, industry_letter) %>%
  spread(key = industry_letter, value = contrib_amount) %>%
  rename(pac_ag = A,
         pac_comms_electric = C,
         pac_const_pub_wrks = B,
         pac_defense = D,
         pac_engy_res_envrmt = E,
         pac_fncs_ins_real = `F`,
         pac_commerce = G,
         pac_hlth_edu_human = H,
         pac_ideological = J,
         pac_labor = L,
         pac_legal = K,
         pac_manu = M,
         pac_other = X,
         pac_trans = `T`,
         pac_unknown = Y) %>%
  mutate_at(vars(pac_ag:pac_unknown), funs(ifelse(is.na(.), 0, .))) %>%
  arrange(receipt_id)

pac.contrib.data$pac_total <- rowSums(pac.contrib.data[ , 2:18], na.rm = TRUE)

# Combine data
contrib.data <- left_join(
  indiv.contrib.data,
  pac.contrib.data,
  by = c("receipt_id")
)
```

## Merge with Legislator Data

```{r}
member.data <- left_join(
  member.data,
  contrib.data,
  by = c("opensecrets_id" = "receipt_id")
)
```


# Select Final Data Set

```{r}
estimation.data <- 
  member.data %>%
  select(opensecrets_id, first_name, last_name, district, party, no_corp_pacs,
         new_member, tot_pac_money, num_pac_contribs, business_pacs,
         ideological_pacs, labor_pacs, pac_cand_committee, pac_party_committee, 
         net_indiv_total, large_indiv, small_indiv, candidate_contribs, 
         indiv_ideological, indiv_cand_committee, indiv_jnt_cand_committee, 
         indiv_party_committee, indiv_self_finance, net_spent, net_receipts, 
         vote_pct, vap_turnout, median_hh_income, pct_clinton_16, pct_obama_12, 
         pct_dem_house_16, pct_dem_house_14, pct_asian, pct_white, pct_black, 
         pct_latino, pct_bachelors, tot_voting_age, indiv_total, pac_total) %>%
  mutate(vote_pct = vote_pct * 100,
         vap_turnout = vap_turnout * 100,
         pct_dem_house_14 = as.numeric(pct_dem_house_14))

save(estimation.data, file = "Data/Clean Data/estimation_data.RDa")
```


# Final Data Set Summary Statistics 

```{r Summary Statistics, echo = TRUE}
psych::describeBy(estimation.data, group = estimation.data$no_corp_pacs)
```

## Acknowledgements {.appendix}

All data cleaning was done using RStudio running **R** version 
`r R.version$major`.`r R.version$minor` "`r R.version$nickname`".



