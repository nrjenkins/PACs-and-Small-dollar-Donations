---
title: "Step I: Data Cleaning"
subtitle: "Project.title"
author:
  - name: Nicholas R. Jenkins 
    affiliation: University of California, Riverside
    affiliation_url: https://www.ucr.edu
description: |
  This document shows all the code used to clean the data for this project. 
  Each step has been carefully documented and will replicate the data set used
  in the study. For any questions about this code, please contact 
  Nick Jenkins at [nicholas.jenkins@email.ucr.edu](mailto:nicholas.jenkins@email.ucr.edu).
abstract: |
  This document shows all the code used to clean the data for this project. 
  Each step has been carefully documented and will replicate the data set used
  in the study. For any questions about this code, please contact 
  Nick Jenkins at [nicholas.jenkins@email.ucr.edu](mailto:nicholas.jenkins@email.ucr.edu).
date: "`r Sys.Date()`"
output: 
  radix: radix::radix_article
  html_notebook: 
    highlight: monochrome
    theme: simplex
    toc: yes
    code_folding: 
  html_document:
    highlight: monochrome
    theme: simplex
    toc: yes
    code_folding:
  pdf_document:
    toc: yes
  github_document:
    toc: yes
#bibliography: /Users/nick/Documents/Research/References/BibTeX/biblatex.bib
editor_options: 
  chunk_output_type: console
---

# Environment Preperation

This section clears the current working environment and loads the packages used to clean the data. I also create the function `comma()` to format any in-line output values to have thousands separators and only two digits. 

```{r setup, warning = FALSE, message = FALSE, results = "hide", echo = TRUE}
# Clear Environment -----------------------------------------------------------
rm(list = ls())

# Load Packages ---------------------------------------------------------------
packages <- c("tidyverse", "stargazer", "foreign", "sqldf", "readxl", 
              "openintro")
lapply(packages, require, character.only = TRUE)

# Inline Formatting -----------------------------------------------------------
comma <- function(x) format(x, digits = 2, big.mark = ",")
```


# Legislator Data

```{r}
members.2018.data.raw <- read_xlsx("Data/Raw Data/OpenSecrets.org _ No Corp PAC Members.xlsx", 
                                   skip = 1,
                                   sheet = "All Cands 2018")
members.2018.data <- 
  members.2018.data.raw %>%
  mutate(NoCorpPACs = as_factor(NoCorpPACs),
         Party = as_factor(Party),
         Party = relevel(Party, ref = "I")) %>%
  rename(new_member = `New Member?`,
         no_corp_pacs = NoCorpPACs,
         opensecrets_id = `Candidate ID`,
         candidae_name = CRPName,
         party = Party,
         district = District,
         gen_election_result = `General Elec Result`,
         vote_pct = VotePercent,
         tot_pac_money = `Total PAC Money`,
         num_pac_contribs = `Number of PAC Contributions`,
         business_pacs = `Business PACs`,
         labor_pacs = `Labor PACs`,
         ideological_pacs = `Ideological PACs`,
         leadership_pacs = `Lead PACs`,
         other_pacs = `Other PACs`,
         net_receipts = `Net Receipts`,
         net_indiv_total = `Net Individual Total`,
         candidate_contribs = `Candidate Contributions`,
         large_indiv = `Large Indivs`,
         small_indiv = `Small Indivs`,
         net_spent = `Net Spent`) %>%
  separate(candidae_name, into = c("first_name", "last_name"), extra = "drop") %>%
  mutate(first_initial = str_sub(first_name, start = 1L, end = 1L),
         last_stub = str_sub(last_name, start = 1L, end = 3L))
```


# Demographic Data

```{r}
demo.data.raw <- read_excel("Data/Raw Data/Demographic Data/115th Congress Members Guide with Elections and Demographic Data by District.xlsx",
                            sheet = "House - Working")

demo.data <- 
  demo.data.raw %>%
  mutate(district_code = str_replace(district_code, pattern = "-", replacement = ""),
         district_code = ifelse(district == "Alaska At-Large", "AK01", district_code),
         district_code = ifelse(district == "Delaware At-Large", "DE01", district_code),
         district_code = ifelse(district == "Montana At-Large", "MT01", district_code),
         district_code = ifelse(district == "North Dakota At-Large", "ND01", district_code),
         district_code = ifelse(district == "South Dakota At-Large", "SD01", district_code),
         district_code = ifelse(district == "Vermont At-Large", "VT01", district_code),
         district_code = ifelse(district == "Wyoming At-Large", "WY01", district_code)) %>%
  rename(state_dist = district_code)

# total voting age pop
library(tidycensus)
census_api_key("b52b951af88427dcca3cee53db4fb1f76da8009d", install = TRUE)

v18 <- load_variables(year = 2017, dataset = "acs5/subject", cache = TRUE)
	
voting.age <- get_acs(geography = "congressional district", variables = "S0101_C01_026")
voting_age <- 
  voting.age %>%
  rename(tot_voting_age = estimate) %>%
  separate(NAME,
           into = c("district", "state"),
           sep = ",",
           extra = "merge") %>%
  mutate(district = str_replace(district, "\\(115th Congress\\)", ""),
         district = str_replace(district, "Congressional District ", ""),
         district = str_trim(district, side = "both"),
         district = str_pad(district, width = 2, side = "left", pad = "0"),
         state = str_trim(state, side = "both"),
         state_dist = paste(state2abbr(state), district, sep = ""),
         state_dist = str_replace(state_dist, pattern = "\\(at Large\\)", "01")) %>%
  dplyr::select(-variable, -moe, -GEOID, -district, -state)

demo.data <- left_join(
  demo.data,
  voting_age,
  by = c("state_dist")
)
```

## Merge legislator data with demographics

```{r}
sum(duplicated(members.2018.data[ , c("district")]))
sum(duplicated(demo.data[ , c("district")]))

member.data <- left_join(
  members.2018.data,
  demo.data,
  by = c("district" = "state_dist")
)
```

# Election Data

```{r}
election.data.raw <- read_csv("/Users/nick/Documents/Research/Projects/PACs and Small-dollar Donations/Data/Raw Data/Election Data/1976-2018-house.csv") %>% filter(year == 2018) %>% filter(stage == "gen")

election.data <- 
  election.data.raw %>%
  mutate(district = str_pad(district, width = 2, side = "left", pad = "0"),
         vote_pct = candidatevotes / totalvotes,
         first_initial = str_sub(candidate, start = 1L, end = 1L)) %>%
  filter(!is.na(candidate)) %>%
  separate(candidate, into = c("first_name", "last_name"), extra = "drop") %>%
  mutate(last_stub = str_sub(last_name, start = 1L, end = 3L),
         state_dist = paste(state_po, district, sep = ""),
         party = case_when(party == "democrat" ~ "D",
                           party == "republican" ~ "R")) %>%
  filter(!is.na(party)) %>%
  dplyr::select(state_dist, party, first_initial, first_name, last_name, last_stub,
         candidatevotes, totalvotes, office)

election.data <- 
  election.data %>%
  mutate(state_dist = ifelse(state_dist == "AK00", "AK01", state_dist),
         state_dist = ifelse(state_dist == "DE00", "DE01", state_dist),
         state_dist = ifelse(state_dist == "MT00", "MT01", state_dist),
         state_dist = ifelse(state_dist == "ND00", "ND01", state_dist),
         state_dist = ifelse(state_dist == "SD00", "SD01", state_dist),
         state_dist = ifelse(state_dist == "VT00", "VT01", state_dist),
         state_dist = ifelse(state_dist == "WY00", "WY01", state_dist))
```

## Merge Election Data with Contribution Data

```{r}
sum(duplicated(election.data[ , c("state_dist", "party", "first_initial", "last_stub")]))
sum(duplicated(member.data[ , c("district", "party", "first_initial", "last_stub")]))

member.data <- left_join(
  member.data,
  election.data,
  by = c("district" = "state_dist", "party", "first_initial", "last_stub")
)

member.data <- 
  member.data %>%
  mutate(new_member = as_factor(new_member),
         party = as_factor(party),
         vap_turnout = candidatevotes / tot_voting_age) %>%
  dplyr::select(opensecrets_id, first_name.x, last_name.x, district, party, 
                new_member, no_corp_pacs, tot_pac_money, num_pac_contribs, 
                business_pacs, labor_pacs, ideological_pacs, leadership_pacs, 
                other_pacs, net_receipts, net_indiv_total, candidate_contribs, 
                large_indiv, small_indiv, net_spent, vote_pct, vap_turnout, 
                median_hh_income, pct_clinton_16, pct_obama_12, 
                pct_dem_house_16,pct_dem_house_14, pct_asian, pct_white, 
                pct_black, pct_latino, pct_bachelors, tot_voting_age, office) %>%
  filter(!is.na(office)) %>%
  dplyr::select(-office) %>%
  rename(first_name = first_name.x,
         last_name = last_name.x)
```


# Select Final Data Set

```{r}
estimation.data <- member.data

save(estimation.data, file = "Data/Clean Data/estimation_data.RDa")
```



# Final Data Set Summary Statistics 

```{r Summary Statistics, echo = TRUE}
psych::describeBy(estimation.data, group = estimation.data$no_corp_pacs)
```

## Acknowledgements {.appendix}

All data cleaning was done using RStudio running **R** version 
`r R.version$major`.`r R.version$minor` "`r R.version$nickname`".



